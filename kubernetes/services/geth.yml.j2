apiVersion: extensions/v1beta1
kind:       Deployment
metadata:
  name: geth
spec:
  replicas:             1
  revisionHistoryLimit: 1
  template:
    metadata:
      labels:
        run: geth
    spec:
      containers:
        - name:             geth
          image:            {{ docker_registry }}/{{image_prefix }}geth:{{ image_version }}
          imagePullPolicy:  Always
          args:             [
              "--rinkeby",
              "--datadir",  "/blockchain/.ethereum/rinkeby/",
              "--syncmode", "fast",
              # SYNC: Make sure to give the container enough RAM to fit the cache.
              # Also remember that geth needs significantly more memory than just cache so don't set it to the same value.
              "--cache",    "512",
              "--rpc",
              "--rpcaddr",    "0.0.0.0",
              "--rpcvhosts",  "geth, geth.default, geth.default.svc.cluster.local",
              # These APIs are used by golem smart contract interface.
              # First one is for basic methods with use json, second one is for basic methods with use javascript for example to connect to geth RPC,
              # third one is used to check network status for example peer count
              "--rpcapi",     "eth, web3, net",
              "--ipcdisable"
          ]
          livenessProbe:
            httpGet:
              path: /
              port: 8545
              httpHeaders:
                - name:  Content-Type
                  value: application/json
            initialDelaySeconds: 5
            periodSeconds:       8
          readinessProbe:
            exec:
              command: ["/usr/local/bin/is-geth-synchronized.sh", "127.0.0.1:8545"]
            # This is average time of geth is up and start a synchronization.
            initialDelaySeconds: 70
            periodSeconds:       10
          resources:
            requests:
              # SYNC: Make sure that the memory limits for the pod include the cache size defined above.
              memory: "2.5Gi"
              cpu:    "700m"
            limits:
              memory: "3Gi"
              cpu:    "1100m"
          volumeMounts:
            - mountPath:  /blockchain
              name:       geth-storage
      volumes:
        - name: geth-storage
          gcePersistentDisk:
            pdName: {{ concent_versions[concent_version].geth_disk }}
            fsType: ext4
---
apiVersion: v1
kind:       Service
metadata:
  name: geth
  labels:
    run: geth
spec:
  type: ClusterIP
  ports:
    - port:       8545
      targetPort: 8545
      name:       geth-rpc-port
  selector:
    run: geth
