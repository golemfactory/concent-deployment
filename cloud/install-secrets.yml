- hosts:
    - concent-builder
  vars_files:
    - ../concent-builder/consts.yml
    - "{{ deployment_values }}/var.yml"
    - "{{ deployment_values }}/var-{{ cluster }}.yml"
  tasks:
    - become:      yes
      become_user: "{{ shared_user }}"
      block:
        - name: Create a directory for secrets
          file:
            path:  "{{ secret_dir }}/{{ item }}/"
            state: directory
          with_items:
            - "{{ cluster }}"
            - cloud

    - become:      yes
      become_user: root
      block:
        # NOTE: Doing this as root because Ansible's copy module has a bug which causes issues with
        # permissions when become_user is different than the user used to execute the playbook on the remote machine.
        # https://github.com/ansible/ansible/issues/21145
        - name: Upload secrets
          copy:
            src:   "{{ local_secret_dir }}/{{ cluster }}/{{ item }}"
            dest:  "{{ secret_dir }}/{{ cluster }}/{{ item }}"
            owner: "{{ shared_user }}"
            group: "{{ shared_user }}"
          with_items:
            - cluster-secrets.yml
            - "../cloud/{{ gke.service_account_name }}-private-key.json"
            - nginx-proxy-ssl.crt
            - nginx-proxy-ssl.key
            - nginx-storage-ssl.crt
            - nginx-storage-ssl.key

    - become:      yes
      become_user: "{{ shared_user }}"
      block:
        - name: Activate the service account that has permissions to access the cluster
          command: gcloud auth activate-service-account                                                           \
              "{{ gke.service_account_name }}@{{ gke.project }}.iam.gserviceaccount.com"                          \
              --key-file "{{ secret_dir }}/cloud/{{ gke.service_account_name }}-private-key.json"

        - name: Configure kubectl to operate on the right cluster
          command: gcloud container clusters get-credentials \
              "{{ gke.cluster }}"                            \
              --project "{{ gke.project }}"                  \
              --zone    "{{ gke.zone }}"
